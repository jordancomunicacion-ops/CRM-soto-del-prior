generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// --- CORE CRM MODELS ---

model CustomerProfile {
  id        String   @id @default(uuid())
  email     String?  @unique
  phone     String?
  firstName String?
  lastName  String?
  
  // Aggregated Stats
  systemTags     String? // "HOTEL_GUEST", "RESTAURANT_DINER", "SHOP_BUYER"
  totalSpend     Decimal @default(0)
  lastInteraction DateTime?
  
  // Consent
  consentEmail    Boolean @default(false)
  consentWhatsApp Boolean @default(false)
  
  campaigns      CampaignLog[]
  webVisits      WebVisit[]
  sales          Sale[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WebVisit {
  id                String   @id @default(uuid())
  sessionId         String
  visitorId         String?
  url               String
  referrer          String?
  userAgent         String?
  duration          Int?    // seconds
  customerProfileId String?
  customerProfile   CustomerProfile? @relation(fields: [customerProfileId], references: [id])
  timestamp         DateTime @default(now())
}

model Campaign {
  id          String   @id @default(uuid())
  name        String
  type        String   // "EMAIL", "WHATSAPP"
  status      String   // "DRAFT", "SCHEDULED", "SENT"
  subject     String?
  content     String   // HTML or Template
  
  sentCount   Int      @default(0)
  createdAt   DateTime @default(now())
  
  logs        CampaignLog[]
}

model CampaignLog {
  id          String   @id @default(uuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id])
  customerProfileId String
  customerProfile CustomerProfile @relation(fields: [customerProfileId], references: [id])
  
  status      String   // "SENT", "OPENED", "CLICKED", "FAILED"
  sentAt      DateTime @default(now())
}

// --- INTELLIGENCE & SALES ---

// --- INTELLIGENCE & SALES ---

model Sale {
  id             String   @id @default(uuid())
  source         String   // "TPV_RESTAURANT", "DELIVERY_PLATFORM" (Ordatic, Flipdish, etc.)
  platformName   String?  // "Glovo", "Uber Eats", "Just Eat" (if Delivery)
  
  total          Decimal
  currency       String   @default("EUR")
  
  customerProfileId String?
  customerProfile   CustomerProfile? @relation(fields: [customerProfileId], references: [id])
  
  // Snapshot of weather at moment of sale (optional, for precise historical record)
  weatherSnapshotJson String? // Stores { temp, condition } as JSON
  
  items          SaleItem[]
  
  timestamp      DateTime @default(now())
  hour           Int      // 0-23
}

model SaleItem {
  id        String   @id @default(uuid())
  saleId    String
  sale      Sale     @relation(fields: [saleId], references: [id])
  
  productName String
  quantity    Int
  unitPrice   Decimal
  category    String?
}

// Independent Hourly Log (Cron Job will fill this)
model HourlyWeather {
  id             String   @id @default(uuid())
  timestamp      DateTime @default(now())
  hour           Int
  
  temperature    Decimal
  condition      String   // "sunny", "rainy", "cloudy"
  precipitation  Decimal  // mm
  humidity       Decimal?
  windSpeed      Decimal?
  
  @@index([timestamp])
}

// --- SOCIAL ANALYTICS (PHASE 8) ---

model SocialAccount {
  id             String   @id @default(uuid())
  provider       String   // "INSTAGRAM", "FACEBOOK", "TIKTOK", "LINKEDIN", "YOUTUBE"
  platformId     String   // The ID on the platform (e.g. IG Business ID)
  name           String   // Account Name / Handle
  
  accessToken    String
  refreshToken   String?
  tokenExpiresAt DateTime?
  
  contentItems   ContentItem[]
  metrics        MetricTimeseries[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model ContentItem {
  id              String   @id @default(uuid())
  socialAccountId String
  socialAccount   SocialAccount @relation(fields: [socialAccountId], references: [id])
  
  externalId      String   // ID of the post/video on the platform
  type            String   // "IMAGE", "VIDEO", "CAROUSEL", "REEL", "STORY"
  permalink       String?
  thumbnail       String?
  caption         String?
  
  publishedAt     DateTime
  
  metrics         MetricTimeseries[] // Metrics specific to this content
  
  // Future: Link to UnifiedCampaign
  campaignId      String? 
  // campaign     UnifiedCampaign? ...
  
  createdAt       DateTime @default(now())
}

model MetricTimeseries {
  id              String   @id @default(uuid())
  
  // Context: Either Account-Level (Followers) or Content-Level (Likes on a Post)
  socialAccountId String
  socialAccount   SocialAccount @relation(fields: [socialAccountId], references: [id])
  
  contentItemId   String?
  contentItem     ContentItem? @relation(fields: [contentItemId], references: [id])
  
  date            DateTime // Date of the record (Daily granularity)
  metric          String   // "IMPRESSIONS", "REACH", "ENGAGEMENT", "FOLLOWERS", "CLICKS"
  value           Decimal
  
  // Metadata for attribution
  source          String?  // "ORGANIC", "PAID"
  
  createdAt       DateTime @default(now())
  
  @@index([socialAccountId, date])
  @@index([contentItemId])
}
